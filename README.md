# ğŸŒˆDeepDeltaE

åœ°å€ï¼šhttps://github.com/Auspiow/DeepDeltaE

å±•ç¤ºï¼šhttps://auspiow.github.io/DeepDeltaE/

```
â”œâ”€.vscode       
â”œâ”€datasets   # æ•°æ®é›†
â”œâ”€frontend   # å‰ç«¯
â”œâ”€hct+xyz    # æ ‡å‡†è½¬æ¢ç®—æ³•
â”œâ”€model      # Siameseæ·±åº¦å­¦ä¹ ç½‘ç»œä»¥åŠè½¬æ¢å‡½æ•°
â””â”€output     # å›¾è¡¨å’Œæ•°æ®
```

å±•ç¤ºæˆªå›¾ï¼š

<img src="./images/display.png" alt="display" style="zoom: 33%;" />



---

## ä¸€. è‰²å½©ç§‘å­¦ç®€ä»‹

### CIEï¼ˆå›½é™…ç…§æ˜å§”å‘˜ä¼šï¼‰

**å…¨ç§°ï¼š** **C**ommission **I**nternationale de l'**Ã‰**clairage å›½é™…ç…§æ˜å§”å‘˜ä¼š

**æˆç«‹äº 1913 å¹´ï¼Œæ€»éƒ¨ä½äºå¥¥åœ°åˆ©ç»´ä¹Ÿçº³ã€‚**ã€1ã€‘

å®ƒæ˜¯å…¨çƒåˆ¶å®š **å…‰ã€é¢œè‰²ã€è§†è§‰æ„ŸçŸ¥æ ‡å‡†** çš„æœ€é«˜ç»„ç»‡ï¼Œå‡ ä¹æ‰€æœ‰ç°ä»£è‰²å½©ç©ºé—´éƒ½å¯è¿½æº¯åˆ° CIE åˆ¶å®šçš„ä½“ç³»ã€‚

ä¸‹é¢çš„å›¾ç‰‡å±•ç¤ºäº†ä»è‰²å½©åŒ¹é…å®éªŒâ†’CIE 1931-RGB è‰²åº¦ç³»ç»Ÿâ†’CIE 1931 XYX è‰²åº¦ç³»ç»Ÿçš„è¿‡ç¨‹ï¼Œä¸»è¦å‚è€ƒçŸ¥ä¹æ–‡ç« ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚



<img src="./images/v2-36b3af8900fe502236344c6622be4f78_r.png" alt="v2-36b3af8900fe502236344c6622be4f78_r" style="zoom:25%;" />

<img src="./images/v2-c168a38b726b38cf7e3ef851039ac406_r.png" alt="v2-c168a38b726b38cf7e3ef851039ac406_r" style="zoom:25%;" />

<img src="./images/v2-39313d9bcec625786ea318b64cbd8f77_1440w.png" alt="v2-39313d9bcec625786ea318b64cbd8f77_1440w" style="zoom:25%;" />

<img src="./images/v2-be28903e6bd5ff7e817708f4f6f87b3f_1440w.png" alt="v2-be28903e6bd5ff7e817708f4f6f87b3f_1440w" style="zoom:25%;" />

<img src="./images/v2-21b121ab49d3ffae0c09483f9cddaf5a_1440w.png" alt="v2-21b121ab49d3ffae0c09483f9cddaf5a_1440w" style="zoom: 33%;" />

### è‰²å½©ç§‘å­¦çš„æ ¸å¿ƒæ€æƒ³

ä¸ºäº†è§£å†³ XYZ â‰  äººç±»æ„Ÿå—çš„é—®é¢˜ï¼ŒCIEæå‡ºäº†å„ç§ **éçº¿æ€§è‰²å½©ç©ºé—´**

æ‰€æœ‰è‰²å½©ç©ºé—´æœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨å»ºç«‹æ˜ å°„ï¼š

**çº¿æ€§å…‰å­¦ï¼ˆç‰©ç†ä¸–ç•Œï¼‰**â†’ æ˜ å°„åˆ° â†’**éçº¿æ€§æ„ŸçŸ¥ï¼ˆäººç±»è§†è§‰ç³»ç»Ÿï¼‰**

è‰²å½©ç§‘å­¦çš„ä»»åŠ¡å°±æ˜¯ï¼š

> **è®©å…‰å­¦ä¸æ„ŸçŸ¥ä¹‹é—´çš„å·®å¼‚ï¼Œé€šè¿‡æ•°å­¦è¢«æè¿°å’Œå¯è®¡ç®—ã€‚**



---

## äºŒ. åˆ©ç”¨æ·±åº¦å­¦ä¹ æ‹Ÿåˆè§†è§‰æ„ŸçŸ¥

#### å‰è¨€

å› ä¸ºç°åœ¨çš„è‰²å½©æ¨¡å‹ï¼ˆXYZ â†’ Lab â†’ CAM16 â†’ HCTï¼‰éƒ½ä¾èµ–ï¼š

- è€æ—§çš„è§†è§‰å®éªŒï¼ˆ1931ã€1964 å¹´çš„äººä½“åŒ¹é…å®éªŒï¼‰
- ç»éªŒå‚æ•°æ‹Ÿåˆ
- äººå·¥å…¬å¼è°ƒå‚
- ç‰¹å®šç¯å¢ƒå‡è®¾ï¼ˆæš—å®¤æ ‡å‡†è§‚å¯Ÿè€…ï¼‰

å®ƒä»¬**ä¸æ˜¯ä¸ºç°ä»£æ˜¾ç¤ºå™¨ã€HDRã€VRã€ARã€å¾®å‹æ˜¾ç¤ºå™¨ã€OLEDã€é‡å­ç‚¹ã€è¶…é«˜äº®åº¦è®¾å¤‡è®¾è®¡çš„**ã€‚

ğŸ‘‰ **è§†è§‰æ¨¡å‹å’Œæ˜¾ç¤ºè®¾å¤‡çš„å·®è·è¶Šæ¥è¶Šå¤§ï¼Œä½†è‰²å½©ç©ºé—´æ²¡è·Ÿä¸Šã€‚**

> â€œå¦‚æœèƒ½è·å¾—è¶³å¤Ÿçš„è§†è§‰æ„ŸçŸ¥æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨æ·±åº¦å­¦ä¹ æ‹Ÿåˆå‡ºæ›´å¥½çš„è‰²å½©ç©ºé—´ã€‚â€

ğŸ‘‰ **ç›®å‰æ²¡æœ‰ä»»ä½•æ¨¡å‹èƒ½æ›¿ä»£ CAM16/HCTã€‚ä¹Ÿæ²¡æœ‰ä»»ä½• transformer æ¨¡å‹åš RGB â†’ æ„ŸçŸ¥çº¿æ€§æ˜ å°„ã€‚**

ä½ ç°åœ¨æƒ³åšçš„è¿™ä¸ªæ–¹å‘å‡ ä¹æ²¡è¢«ç³»ç»ŸåŒ–æ¢ç´¢ã€‚

====>

## åŸºäºSiameseçš„æ„ŸçŸ¥è‰²å·®é¢„æµ‹æ¨¡å‹

æœ¬å·¥ä½œæ—¨åœ¨åˆ©ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹æ‹Ÿåˆæ—§æœ‰è‰²å½©å¿ƒç†ç‰©ç†å®éªŒä¸­çš„â€œäººç±»æ„ŸçŸ¥è‰²å·®â€ï¼ˆhuman perceptual color differenceï¼‰ã€‚ä¼ ç»Ÿè‰²å·®å…¬å¼ï¼ˆå¦‚ Î”E76 / Î”E94 / Î”E2000ï¼‰å‡ä¸ºäººå·¥è®¾è®¡ï¼Œè€Œ AI æ¨¡å‹èƒ½å¤Ÿä»è·¨æ•°æ®é›†çš„å®éªŒæ•°æ®ä¸­è‡ªåŠ¨å­¦ä¹ æ›´ç¬¦åˆäººç±»ä¸»è§‚è§†è§‰ä¸€è‡´æ€§çš„è‰²å·®åº¦é‡ã€‚

ä»¥ä¸‹ä¸ºå®Œæ•´çš„é¡¹ç›®è¯´æ˜æ–‡æ¡£ã€‚

### 1. æ•°æ®é›†å‡†å¤‡ï¼ˆDatasetsï¼‰

ä¸ºäº†æ„å»ºç»Ÿä¸€ä¸”è¦†ç›–è¶³å¤Ÿå¤šé¢œè‰²å¯¹çš„è®­ç»ƒæ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨ GitHub ä¸Š Coloria æ•´åˆä»“åº“ï¼š

ğŸ”— [https://github.com/coloria-dev/color-data](https://github.com/coloria-dev/color-data)

ä»ä¸­é€‰æ‹©äº† 1980â€“1990 å¹´ä»£æœ€ç»å…¸ã€ä½¿ç”¨æœ€å¹¿çš„å¿ƒç†ç‰©ç†å®éªŒæ•°æ®é›†ï¼š

| æ•°æ®é›†          | å…‰æº | è¯´æ˜                                                         |
| --------------- | ---- | ------------------------------------------------------------ |
| bfd-c.json      | C    | Bradford Universityï¼ˆè‹±å›½å¸ƒæ‹‰å¾·ç¦å¾·å¤§å­¦ï¼‰ Fosterç­‰è‰²å½©ç§‘å­¦å®¶å›¢é˜Ÿ |
| bfd-d65.json    | D65  | CIEDE2000 è®¾è®¡æ—¶çš„æ ¸å¿ƒæ•°æ®é›†                                 |
| bfd-m.json      | M    |                                                              |
| leeds.json      | D65  | University of Leedsï¼ˆåˆ©å…¹å¤§å­¦ï¼‰ è‹±å›½æœ€å¼ºçš„è‰²å½©ç§‘å­¦å®éªŒå®¤ä¹‹ä¸€ |
| rit-dupont.json |      | RITï¼ˆRochester Institute of Technologyï¼‰+ DuPontï¼ˆæœé‚¦å…¬å¸ï¼‰è”åˆä½œä¸š |
| witt.json       |      | U. Wittï¼ˆUlrich Wittï¼‰åšå£«  20 ä¸–çºª 80â€“90 å¹´ä»£ç ”ç©¶è‰²å½©è§†è§‰è‰²å·®æ„ŸçŸ¥çš„å­¦è€… |

æœ€ç»ˆæ•°æ®ç›®å½•ç»“æ„ï¼š

```
datasets/
â”œâ”€ bfd-c.json
â”œâ”€ bfd-d65.json
â”œâ”€ bfd-m.json
â”œâ”€ rit-dupont.json
â”œâ”€ leeds.json
â””â”€ witt.json
```

#### 1.1 æ•°æ®æ ¼å¼ï¼ˆç»Ÿä¸€ JSON ç»“æ„ï¼‰

æ¯ä¸ª JSON æ–‡ä»¶å‡åŒ…å«ï¼š

```
{
    "reference_white": [],
    "dv": [],      // äººç±»æ„ŸçŸ¥å·®å¼‚è¯„åˆ† (difference values)
    "pairs": [],   // ç´¢å¼•å¯¹ (i, j)ï¼šè¡¨ç¤ºé¢œè‰² xyz[i], xyz[j]
    "xyz": []      // æ‰€æœ‰ XYZ é¢œè‰²æ ·æœ¬
}
```

åŠ è½½åè½¬æ¢ä¸ºæœ€ç»ˆè®­ç»ƒæ ¼å¼ï¼š

```
L1, a1, b1, L2, a2, b2 â†’ DE_human
```

å®Œæ•´æ•°å­¦å…¬å¼ï¼ˆå®˜æ–¹æ ‡å‡†å…¬å¼ï¼‰

ç»™å®šï¼š

- é¢œè‰² XYZ = (X, Y, Z)
- ç™½ç‚¹ XYZâ‚™ = (Xâ‚™, Yâ‚™, Zâ‚™)

é¦–å…ˆå½’ä¸€åŒ–ï¼š
$$
x = \frac{X}{X_n},\quad y = \frac{Y}{Y_n},\quad z = \frac{Z}{Z_n}
$$
å†å®šä¹‰è¾…åŠ©å‡½æ•°ï¼š
$$
f(t)=
\begin{cases}
t^{1/3} & t > \left(\frac{6}{29}\right)^3 \\
\frac{1}{3}\left(\frac{29}{6}\right)^2 t + \frac{4}{29} & \text{å¦åˆ™}
\end{cases}
$$
ç„¶åï¼š

Lï¼šæ˜åº¦
$$
L^* = 116 f(y) - 16
$$
aï¼šçº¢ç»¿è½´
$$
a^* = 500 (f(x) - f(y))
$$
b\ï¼šé»„è“è½´
$$
b^* = 200 (f(y) - f(z))
$$
å…¶ä¸­ Lab ä½¿ç”¨ `colormath` ä»¥ D65ã€2Â° observer è½¬æ¢ã€‚

---

### 2.æ¨¡å‹è¾“å…¥ / è¾“å‡ºè®¾è®¡

**è¾“å…¥ç‰¹å¾ï¼ˆFeature Designï¼‰**

```
(L1, a1, b1, L2, a2, b2)
```

è¾“å…¥ä¸ºä¸¤ç»„ Lab é¢œè‰²æ‹¼æ¥ï¼Œå¹¶ reshape ä¸ºï¼š

```
batch Ã— 2 Ã— 3
```

ä»¥ä¾¿é€å…¥ Transformer ä½œä¸ºä¸¤ä¸ª tokenã€‚

**è¾“å‡ºï¼ˆTargetï¼‰**

```
y_pred âˆˆ â„  # æ¨¡å‹é¢„æµ‹çš„äººç±»è§†è§‰è‰²å·® Î”E_vis
```

æ­¤ Î”E_vis ä¸æ˜¯ä»»ä½•å·²æœ‰è‰²å·®å…¬å¼ï¼Œè€Œæ˜¯ç›´æ¥æ‹Ÿåˆå®éªŒä¸­çš„â€œä¸»è§‚å·®å¼‚è¯„åˆ†â€ã€‚

#### 2.1 é‡è¦çš„æ•°æ®å¤„ç†

ä¸ºäº†ä½¿è®­ç»ƒæ›´åŠ ç¨³å®šï¼Œä½¿ç”¨ï¼š

- **log(1+Î”E)** æŠ‘åˆ¶é•¿å°¾åˆ†å¸ƒ
- **æ ‡å‡†åŒ–ï¼ˆz-scoreï¼‰** æå‡è®­ç»ƒé€Ÿåº¦
- **æŒ‰ Î”E åŒºé—´é‡‡æ ·ï¼ˆbalanced samplingï¼‰** è®©æ¨¡å‹åœ¨å°å·®å¼‚åŒºåŸŸï¼ˆäººç±»æ•æ„ŸåŒºåŸŸï¼‰å­¦ä¹ æ›´å¤š

---

### 3. æ¨¡å‹ç»“æ„ï¼ˆSiamese for Color Differenceï¼‰

æœ¬é¡¹ç›®ä¸€å¼€å§‹è®¡åˆ’é‡‡ç”¨ä¸€ä¸ªè½»é‡çº§ Transformer ç¼–ç å™¨ï¼Œç”¨äºå­¦ä¹ ä¸¤ä¸ªé¢œè‰² token çš„å…³ç³»ã€‚åæ¥å‘ç°æ‹Ÿåˆæ•ˆæœä¸æ˜¯ç‰¹åˆ«å¥½

äºæ˜¯é‡æ–°é€‰æ‹©äº†æ›´åŠ åˆé€‚çš„æ¨¡å‹ï¼š

**Siamese æ¶æ„**å¤©ç”Ÿé€‚ç”¨äºæ¯”è¾ƒè¾“å…¥å¯¹çš„å·®å¼‚ï¼Œå¹¶ä¸”é€šè¿‡**å…±äº«ç¼–ç å™¨**æå¤§åœ°å‡å°‘äº†æ¨¡å‹å‚æ•°é‡ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆï¼ŒåŒæ—¶åŠ å¿«è®­ç»ƒé€Ÿåº¦ã€‚

é€‰æ‹© **Huber Loss ($\delta=1.0$)** è€Œéä¼ ç»Ÿçš„ MSEã€‚Huber Loss å¯¹äººç±»è¯„åˆ†ä¸­å¯èƒ½å­˜åœ¨çš„å¼‚å¸¸å€¼æˆ–æ ‡æ³¨é”™è¯¯å…·æœ‰æ›´å¥½çš„é²æ£’æ€§ï¼Œå› ä¸ºå®ƒç»“åˆäº† L1 å’Œ L2 æŸå¤±çš„ä¼˜ç‚¹

Siamese ç¼–ç å™¨ + è·ç¦» MLP é¢„æµ‹

```python
class SiameseColorNet(nn.Module):
    def __init__(self, emb_dim=128):
        super().__init__()
        # (L,a,b) â†’ åµŒå…¥å‘é‡
        self.encoder = nn.Sequential(
            nn.Linear(3, 64),
            nn.ReLU(),
            nn.Linear(64, emb_dim),
            nn.ReLU()
        )
        # |e1 - e2| â†’ é¢„æµ‹ log1p(DE)ï¼ˆå½’ä¸€åŒ–åçš„ï¼‰
        self.head = nn.Sequential(
            nn.Linear(emb_dim, emb_dim//2),
            nn.ReLU(),
            nn.Linear(emb_dim//2, 1)
        )

    def forward(self, x):
        B = x.shape[0]
        colors = x.view(B, 2, 3)
        c1, c2 = colors[:,0,:], colors[:,1,:]
        e1, e2 = self.encoder(c1), self.encoder(c2)
        d = torch.abs(e1 - e2)
        out = self.head(d).squeeze(-1)
        return out

model = SiameseColorNet(emb_dim=128).to(DEVICE)
opt = torch.optim.AdamW(model.parameters(), lr=LR, weight_decay=1e-5)
loss_fn = nn.HuberLoss(delta=1.0)
```

---

### 4. åŸºçº¿è‰²å·®å…¬å¼ï¼ˆBenchmarkï¼‰

ä¸ºäº†è¯„ä¼°æ¨¡å‹æ˜¯å¦çœŸæ­£â€œæ¯” Î”E æ›´åƒäººç±»â€ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹åŸºçº¿ï¼š

| Baseline | è¯´æ˜                   |
| -------- | ---------------------- |
| Î”E76     | æ¬§æ°è·ç¦»               |
| Î”E94     | å·¥ä¸šè‰²å·®               |
| Î”E2000   | å½“å‰æœ€å¸¸ç”¨             |
| OKLab Î”E | perceptual color space |

#### Î”E2000

```python
from colormath.color_objects import LabColor
from colormath.color_diff import delta_e_cie2000

def de2000(row):
    c1 = LabColor(row.L1, row.a1, row.b1)
    c2 = LabColor(row.L2, row.a2, row.b2)
    return delta_e_cie2000(c1, c2)
```

---

### 5. è¯„ä»·æŒ‡æ ‡ï¼ˆEvaluation Metricsï¼‰

ä½¿ç”¨çš®å°”é€Šç›¸å…³ç³»æ•° Pearson R è¡¡é‡æ¨¡å‹è¾“å‡ºä¸äººç±»å®éªŒçš„ç›¸å…³æ€§ï¼š

```
from scipy.stats import pearsonr

r = pearsonr(true_values, predicted_values)[0]
```

---

### 6. å¯è§†åŒ–ä¸å®éªŒç»“æœï¼ˆVisualizationï¼‰

#### 6.1 æ•£ç‚¹å›¾ï¼šAI vs Human

```
plt.figure()
plt.scatter(true_all, preds_un, s=6, alpha=0.4)
plt.xlabel("Human score (Î”E raw)")
plt.ylabel("Model prediction (Î”E raw)")
plt.title(f"Siamese Model vs Human (R={r_model:.4f})")
plt.plot([0, max(true_all.max(), preds_un.max())], [0, max(true_all.max(), preds_un.max())], 'r--', linewidth=1)
plt.savefig("scatter_siamese_pred_vs_human.png", dpi=150)
plt.close()
```

<img src="./output/scatter_siamese_pred_vs_human.png" style="zoom: 50%;" />

#### 6.2 è¯¯å·®ç›´æ–¹å›¾ï¼ˆerror histï¼‰

```
err = (preds_un.ravel() - true_all.ravel())
plt.figure()
sns.histplot(err, bins=80, kde=True)
plt.title("Prediction error (pred - human)")
plt.savefig("hist_error_siamese.png", dpi=150)
plt.close()
```

<img src="./output/hist_error_siamese.png" style="zoom:50%;" />

#### 6.3 Rå€¼å¯¹æ¯”å›¾ï¼ˆR comparison barï¼‰

```
plt.figure()
labels = ["Siamese", "Î”E2000"]
vals = [r_model, r_de2000]
sns.barplot(x=labels, y=vals)
plt.ylim(0,1)
plt.title("Pearson R comparison")
plt.savefig("r_comparison_siamese.png", dpi=150)
plt.close()
```

<img src="./output/r_comparison_siamese.png" style="zoom:50%;" />

#### 6.4 å®éªŒç»“æœ

å½“å‰æ¨¡å‹ï¼ˆç»è¿‡ log-scaling + balanced sampling + Huber Lossï¼‰ï¼š

```
R(model)   = 0.9253
R(DE2000)  = 0.7754
```

AI æ¨¡å‹æ˜¾è‘—è¶…è¶Š DE2000ï¼ˆâ‰ˆ +0.15ï¼‰ï¼Œè¾¾åˆ°æ¥è¿‘äººç±»é—´ä¸€è‡´æ€§ï¼ˆinter-observer consistency â‰ˆ 0.90â€“0.95ï¼‰ã€‚

è¯´æ˜æ¨¡å‹ç¡®å®åœ¨å­¦ä¹ â€œäººç±»è§†è§‰æ„ŸçŸ¥â€ï¼Œè€Œä¸ä»…ä»…æ˜¯ Lab å‡ ä½•è·ç¦»ã€‚



---

## 3. ç¥ç»ç½‘ç»œæ¨¡å‹è½¬åŒ–ä¸ºæ•°å­¦å·¥å…·æˆ–ç®—æ³•

å°†è¿™ä¸ªè®­ç»ƒå¥½çš„ç¥ç»ç½‘ç»œæ¨¡å‹**è½¬åŒ–ä¸ºæ•°å­¦å·¥å…·æˆ–ç®—æ³•**ï¼Œä»¥ä¾¿åœ¨å…¶ä»–ç¯å¢ƒæˆ–ç¨‹åºä¸­è°ƒç”¨ï¼Œè€Œæ— éœ€è¿è¡Œå®Œæ•´çš„ PyTorch æ¡†æ¶ï¼Œå¯ä»¥å¤§å¤§æé«˜é¢„æµ‹é€Ÿåº¦å’Œæ˜“ç”¨æ€§ã€‚

æ¨¡å‹ (SiameseColorNet) çš„å·¥ä½œæµç¨‹æ˜¯ï¼š

Lab é¢œè‰²å¯¹ $\rightarrow$ ç¼–ç å™¨ $\rightarrow$ è·ç¦»è®¡ç®— $\rightarrow$ MLP é¢„æµ‹å¤´ $\rightarrow$ $\Delta E$ é¢„æµ‹å€¼

ç”±äºæ‚¨çš„æ¨¡å‹æ˜¯ä¸€ä¸ªç›¸å¯¹ç®€å•çš„ **MLPï¼ˆå¤šå±‚æ„ŸçŸ¥å™¨ï¼‰**ç»“æ„ï¼Œå°†å…¶è½¬åŒ–ä¸ºçº¯æ•°å­¦å‡½æ•°æˆ–ç®—æ³•éå¸¸ç›´æ¥ã€‚

#### 1. æå–æƒé‡å’Œåç½® (Extraction)

ç¥ç»ç½‘ç»œçš„æœ¬è´¨æ˜¯ä¸€ç³»åˆ—çŸ©é˜µä¹˜æ³•å’Œéçº¿æ€§æ¿€æ´»å‡½æ•°çš„ç»„åˆï¼Œä»è®­ç»ƒå¥½çš„æ¨¡å‹ä¸­æå–æ‰€æœ‰å‚æ•°ï¼š

| **å±‚**      | **å‚æ•°**          | **ä½œç”¨**                                       |
| ----------- | ----------------- | ---------------------------------------------- |
| `encoder.0` | $W_{e1}, B_{e1}$  | ç¬¬ 1 å±‚æƒé‡/åç½®ï¼ˆ3 $\rightarrow$ 64ï¼‰         |
| `encoder.2` | $W_{e2}, B_{e2}$  | ç¬¬ 2 å±‚æƒé‡/åç½®ï¼ˆ64 $\rightarrow$ 128ï¼‰       |
| `head.0`    | $W_{h1}, B_{h1}$  | é¢„æµ‹å¤´ç¬¬ 1 å±‚æƒé‡/åç½®ï¼ˆ128 $\rightarrow$ 64ï¼‰ |
| `head.2`    | $W_{h2}, B_{h2}$  | é¢„æµ‹å¤´ç¬¬ 2 å±‚æƒé‡/åç½®ï¼ˆ64 $\rightarrow$ 1ï¼‰   |
| ç›®æ ‡å€¼      | $\mu_y, \sigma_y$ | å½’ä¸€åŒ–/åå½’ä¸€åŒ–æ‰€éœ€çš„å‡å€¼å’Œæ ‡å‡†å·®              |

æ“ä½œï¼š

åœ¨ model.py ä¸­æ¨¡å‹è®­ç»ƒå®Œæˆåï¼ŒåŠ è½½æ¨¡å‹æƒé‡ï¼Œå¹¶ä½¿ç”¨ model.state_dict() å°†è¿™äº›å¼ é‡å‚æ•°ä¿å­˜ä¸º .npy æˆ–å…¶ä»–æ˜“äºè¯»å–çš„æ ¼å¼ã€‚

#### 2. æ¨¡å‹æ ¸å¿ƒç®—æ³• (The Algorithm)

å¯¹äºä¸€å¯¹é¢œè‰² $C_1 = (L_1, a_1, b_1)$ å’Œ $C_2 = (L_2, a_2, b_2)$ï¼Œé¢„æµ‹ $\Delta E_{pred}$ çš„ç®—æ³•æ­¥éª¤å¦‚ä¸‹ï¼š

1. ç¼–ç å™¨ï¼ˆå…±äº«ï¼‰ï¼š

   $$\begin{aligned} E_1 &= \text{ReLU}(C_1 W_{e1} + B_{e1}) \\ E_1 &= \text{ReLU}(E_1 W_{e2} + B_{e2}) \\ E_2 &= \text{ReLU}(C_2 W_{e1} + B_{e1}) \\ E_2 &= \text{ReLU}(E_2 W_{e2} + B_{e2})\end{aligned}$$

   ï¼ˆæ³¨æ„ï¼šæ­¤å¤„çš„ $W$ æ˜¯çŸ©é˜µï¼Œè®¡ç®—é¡ºåºå¯èƒ½ä¸º $C \cdot W^T$ æˆ– $C \cdot W$ å–å†³äº PyTorch çš„å®ç°ï¼Œä½†æ•°å­¦ä¸Šæ˜¯ä¸€è‡´çš„ã€‚ï¼‰

2. è·ç¦»è®¡ç®—ï¼š

   $$D = |E_1 - E_2|$$

3. é¢„æµ‹å¤´ï¼ˆMLPï¼‰ï¼š

   $$H = \text{ReLU}(D W_{h1} + B_{h1})$$

   $$\Delta E_{norm} = H W_{h2} + B_{h2}$$

4. åå½’ä¸€åŒ– (Inverse Normalization)ï¼š

   $$\Delta E_{log} = \Delta E_{norm} \cdot \sigma_y + \mu_y$$

5. å $\text{log}(1+x)$ å˜æ¢ï¼š

   $$\Delta E_{pred} = e^{\Delta E_{log}} - 1$$

 `.pth` æ–‡ä»¶ä¸­åŒ…å«äº†SiameseColorNet æ¨¡å‹ç»è¿‡å¤æ‚è®­ç»ƒåå¾—åˆ°çš„æ‰€æœ‰**æ•°å€¼åŒ–â€œçŸ¥è¯†â€**ï¼Œå³æ‰€æœ‰çš„æƒé‡ ($W$) å’Œåç½® ($B$)ã€‚

```
# =======================================================
# 2. åŠ è½½æƒé‡å¹¶æå–å‚æ•°
# =======================================================
PTH_PATH = "output/checkpoints_siamese.pth" 
OUTPUT_DIR_ALGO = "output/algorithm_params" # æ–°çš„å‚æ•°è¾“å‡ºç›®å½•
os.makedirs(OUTPUT_DIR_ALGO, exist_ok=True)

model = SiameseColorNet(emb_dim=128)
# æ— è®ºè®­ç»ƒæ—¶æ˜¯å¦ä½¿ç”¨GPUï¼Œæˆ‘ä»¬éƒ½åŠ è½½åˆ°CPUä¸Š
state_dict = torch.load(PTH_PATH, map_location=torch.device('cpu')) 
model.load_state_dict(state_dict)
model.eval()

# å­˜å‚¨æ‰€æœ‰æå–çš„å‚æ•°çš„å­—å…¸
extracted_params = {}

# éå†æ¨¡å‹ä¸­çš„æ‰€æœ‰å‘½åå‚æ•°
for name, param in model.named_parameters():
    # å°† PyTorch Tensor è½¬æ¢ä¸º NumPy æ•°ç»„
    np_array = param.data.numpy() 
    
    # è§„èŒƒåŒ–åç§°ï¼Œä¾¿äºåç»­ä»£ç ä¸­è¯†åˆ« (ä¾‹å¦‚ï¼šencoder_0_W, head_2_B)
    clean_name = name.replace('.', '_')
    extracted_params[clean_name] = np_array
    
    # å°†æ¯ä¸ªå‚æ•°å•ç‹¬ä¿å­˜ä¸º .npy æ–‡ä»¶
    np.save(os.path.join(OUTPUT_DIR_ALGO, f"{clean_name}.npy"), np_array)
    print(f"å·²ä¿å­˜å‚æ•°: {clean_name}.npy, å½¢çŠ¶: {np_array.shape}")
```

è¿è¡Œexport.pyä»£ç åï¼Œæ‚¨çš„ `output/algorithm_params` æ–‡ä»¶å¤¹ä¸­å°†åŒ…å«æ‰€æœ‰çš„ **`.npy` æ–‡ä»¶**ï¼Œä¾‹å¦‚ï¼š

- `encoder_0_weight.npy`
- `encoder_0_bias.npy`
- ...
- `head_2_weight.npy`
- `head_2_bias.npy`
- `NORM_MEAN.npy`
- `NORM_STD.npy`

#### è¾“å…¥/å¸¸æ•°

- **è¾“å…¥å‘é‡ï¼š** $C_1 = (L_1, a_1, b_1)$ å’Œ $C_2 = (L_2, a_2, b_2)$ã€‚
- **æ¨¡å‹å¸¸æ•°ï¼š** å…± 8 ä¸ªæƒé‡å’Œåç½®çŸ©é˜µï¼ˆ$W, B$ï¼‰ï¼Œä»¥åŠ 2 ä¸ªå½’ä¸€åŒ–å¸¸æ•°ï¼ˆ$\mu_y, \sigma_y$ï¼‰ã€‚
  - **å½’ä¸€åŒ–å¸¸æ•°ï¼š** $\mu_y = y_{mean}$ï¼Œ$\sigma_y = y_{std}$ã€‚
  - **æƒé‡/åç½®ï¼š** $W_{e1}, B_{e1}, W_{e2}, B_{e2}$ (ç¼–ç å™¨)ï¼›$W_{h1}, B_{h1}, W_{h2}, B_{h2}$ (é¢„æµ‹å¤´)ã€‚

#### ç®—æ³•æ­¥éª¤

##### A. é¢œè‰²ç¼–ç å™¨ (Siamese Encoder)

å¯¹ $C_1$ å’Œ $C_2$ ä½¿ç”¨å…±äº«çš„æƒé‡çŸ©é˜µï¼Œè®¡ç®—å…¶ 128 ç»´çš„åµŒå…¥å‘é‡ ($E_1, E_2$)ï¼š

$$\begin{aligned} E_{1\_hidden} &= \text{ReLU}(C_1 W_{e1}^T + B_{e1}) \\ E_1 &= \text{ReLU}(E_{1\_hidden} W_{e2}^T + B_{e2}) \\ E_{2\_hidden} &= \text{ReLU}(C_2 W_{e1}^T + B_{e1}) \\ E_2 &= \text{ReLU}(E_{2\_hidden} W_{e2}^T + B_{e2}) \end{aligned}$$

##### B. å·®å¼‚åº¦é‡ä¸é¢„æµ‹å¤´ (Difference and Prediction Head)

è®¡ç®—åµŒå…¥è·ç¦»ï¼Œå¹¶é€šè¿‡ MLP é¢„æµ‹å½’ä¸€åŒ–åçš„ $\Delta E$ å€¼ï¼š

$$\begin{aligned} D &= |E_1 - E_2| \quad \text{(è®¡ç®—ç»å¯¹å·®å€¼)} \\ H &= \text{ReLU}(D W_{h1}^T + B_{h1}) \\ \Delta E_{norm} &= H W_{h2}^T + B_{h2} \end{aligned}$$

##### C. åå½’ä¸€åŒ–ä¸æœ€ç»ˆ $\Delta E$

å°†é¢„æµ‹ç»“æœåå‘è½¬æ¢ï¼Œå¾—åˆ°æœ€ç»ˆçš„äººçœ¼æ„ŸçŸ¥é¢œè‰²å·®å¼‚å€¼ï¼š

$$\begin{aligned} \Delta E_{log} &= \Delta E_{norm} \cdot \sigma_y + \mu_y \\ \Delta E_{pred} &= \exp(\Delta E_{log}) - 1 \end{aligned}$$

å¯èƒ½çš„åº”ç”¨åœºæ™¯:

| **è¡Œä¸š**                      | **åº”ç”¨åœºæ™¯**           | **ä»·å€¼ä½“ç°**                                                 |
| ----------------------------- | ---------------------- | ------------------------------------------------------------ |
| **åˆ¶é€ ä¸š (å¡‘æ–™ã€æ²¹æ¼†ã€çººç»‡)** | **æ™ºèƒ½è´¨é‡æ§åˆ¶**       | ç”¨äºå®æ—¶æ£€æµ‹ç”Ÿäº§çº¿ä¸Šäº§å“çš„é¢œè‰²åå·®ã€‚ç”±äºæ‚¨çš„æ¨¡å‹ä¸äººçœ¼æ„ŸçŸ¥ç›¸å…³æ€§æ›´é«˜ï¼Œå®ƒèƒ½æ›´å‡†ç¡®åœ°åˆ¤æ–­äº§å“æ˜¯å¦ä¼šå› é¢œè‰²é—®é¢˜è€Œè¢«äººç±»å®¢æˆ·æ‹’ç»ï¼Œä»è€Œ**å‡å°‘è¯¯åˆ¤å’Œä¸å¿…è¦çš„åºŸå“**ã€‚ |
| **å°åˆ·å’ŒåŒ…è£…**                | **å°åˆ·æ ¡å‡†å’Œå®¹å·®è®¾å®š** | ç”¨äºå®šä¹‰å°åˆ·å“çš„æœ€å¤§å¯æ¥å—é¢œè‰²å·®å¼‚ã€‚ä½¿ç”¨æ›´å‡†ç¡®çš„ $\Delta E_{vis}$ (æ‚¨çš„æ¨¡å‹é¢„æµ‹å€¼)ï¼Œå¯ä»¥ç¡®ä¿ä¸åŒæ‰¹æ¬¡ã€ä¸åŒæ‰“å°æœºä¹‹é—´çš„é¢œè‰²ä¸€è‡´æ€§ã€‚ |
| **æ•°å­—åŒ–è®¾è®¡ (CAD/3D)**       | **æè´¨æ¸²æŸ“éªŒè¯**       | åœ¨è™šæ‹Ÿç°å®æˆ– 3D æ¸²æŸ“ä¸­ï¼Œç”¨äºéªŒè¯è™šæ‹Ÿæè´¨çš„é¢œè‰²æ˜¯å¦ä¸ç›®æ ‡é¢œè‰²åŒ¹é…ã€‚è¿™ç¡®ä¿äº†åœ¨ä¸åŒæ˜¾ç¤ºå™¨å’Œå…‰ç…§ä¸‹çš„é¢œè‰²ä¸€è‡´æ€§ã€‚ |
| **è‰²å½©ç®¡ç†è½¯ä»¶**              | **æ ¸å¿ƒå·®å¼‚è®¡ç®—**       | å¯ä»¥é›†æˆåˆ°ä¸“ä¸šçš„è‰²å½©ç®¡ç†è½¯ä»¶ä¸­ï¼Œä½œä¸º $\Delta E$ è®¡ç®—çš„æ–°æ ‡å‡†ï¼Œä¸ºç”¨æˆ·æä¾›æ¯” $\Delta E_{2000}$ æ›´ç¬¦åˆäººçœ¼æ„Ÿå—çš„é¢œè‰²å·®å¼‚æŒ‡æ ‡ã€‚ |



### å‚è€ƒèµ„æ–™/æ–‡çŒ®

ã€1ã€‘ç»´åŸºç™¾ç§‘/CIE

https://zh.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E7%85%A7%E6%98%8E%E5%A7%94%E5%91%98%E4%BC%9A

ã€2ã€‘ç»´åŸºç™¾ç§‘/CIE 1931è‰²å½©ç©ºé—´

https://zh.wikipedia.org/wiki/CIE_1931%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4

ã€3ã€‘ Colour-Science ä»“åº“

https://www.colour-science.org/api/0.3.2/html/_modules/colour/models/rgb.html

ã€4ã€‘Google/material-color-utilitieså®˜æ–¹githubä»“åº“

https://github.com/material-foundation/material-color-utilities/tree/main/dart/lib/hct

ã€5ã€‘çŸ¥ä¹ è‰²åŸŸé©¬è¹„å›¾æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿâ€”â€”CIE 1931 XYZè‰²å½©ç©ºé—´è¯¦è§£

https://zhuanlan.zhihu.com/p/137639368

ã€6ã€‘æ•°æ®é›†æ¥æº

https://github.com/coloria-dev/color-data
